import { existsSync, mkdirSync, rmSync, writeFileSync } from "node:fs";
import { dirname, join } from "node:path";
import { fileURLToPath } from "node:url";
import { generateTauriArtifacts } from "@zakstam/codex-local-component/host/tauri";

const here = dirname(fileURLToPath(import.meta.url));
const appRoot = join(here, "..");

const iconPath = join(appRoot, "src-tauri", "icons", "icon.png");
if (!existsSync(iconPath)) {
  throw new Error(`Missing required Tauri icon: ${iconPath}`);
}

const distDir = join(appRoot, "dist");
mkdirSync(distDir, { recursive: true });
const distIndexPath = join(distDir, "index.html");
if (!existsSync(distIndexPath)) {
  writeFileSync(
    distIndexPath,
    "<!doctype html><html><head><meta charset=\"utf-8\"></head><body><div id=\"root\"></div></body></html>\n",
    "utf8",
  );
}

const generated = generateTauriArtifacts();
const rustSrcDir = join(appRoot, "src-tauri", "src");
writeFileSync(join(rustSrcDir, "bridge_contract_generated.rs"), generated.rustContractSource, "utf8");
writeFileSync(join(rustSrcDir, "bridge_dispatch_generated.rs"), generated.rustDispatchSource, "utf8");
writeFileSync(
  join(rustSrcDir, "bridge_invoke_handlers_generated.rs"),
  generated.rustInvokeHandlersSource,
  "utf8",
);

const permissionsDir = join(appRoot, "src-tauri", "permissions", "autogenerated");
rmSync(permissionsDir, { recursive: true, force: true });
mkdirSync(permissionsDir, { recursive: true });
for (const file of generated.permissionFiles) {
  writeFileSync(join(permissionsDir, file.filename), file.contents, "utf8");
}
